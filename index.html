<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <title>timerboard.net</title>
    <style type="text/css">
        label {
            font-size: large;
            text-align: right
        }
        input {
            width: 70%;
            float: right;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-default">
        <div class="container">
            <div class="navbar-header">
                <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">
                        Toggle navigation
                    </span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/"><i class="fa fa-calendar"></i> timerboard.net
                </a>
            </div>
            <nav class="collapse navbar-collapse navbar-ex1-collapse" role="navigtion">
            </nav>
        </div>
    </nav>
    <div class="container">
        <div id="timers"></div>
        <script>
            var ICON_ASC = '<i class="fa fa-sort-amount-asc"/></i>';
            var ICON_DESC = '<i class="fa fa-sort-amount-desc"/></i>';
        </script>
    </div>
    <hr />
    <footer>
        <div class="container">
            <p class=".small text-center text-muted">This is a fork of <a href="https://github.com/xxpizzaxx/timerboard-net-fozziesov">timerboard-net-fozziesov</a>, fed by data from <a href="https://github.com/xxpizzaxx/pizza-sov-relay">pizza-sov-relay</a> which are both available under the <a href="http://opensource.org/licenses/MIT">MIT License</a>.</p>
        </div>
    </footer>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/system2region.json.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
    <script src="https://fb.me/react-0.13.3.js" type="text/javascript"></script>
    <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>
    <script type="text/jsx">
        var Timer = React.createClass({
            componentDidMount: function() {
                var interval = setInterval(function(){
                    React.findDOMNode(this.refs.fuzzytime).innerHTML = moment(this.props.timer.time).calendar();
                    var remaining = moment(this.props.timer.time).diff(moment(), 'seconds');
                    var d = Math.floor(remaining / 86400),
                        h = Math.floor(remaining % 86400 / 3600),
                        m = Math.floor(remaining % 3600 / 60),
                        s = remaining % 60;
                    React.findDOMNode(this.refs.remaining).innerHTML = d + 'd ' + h + 'h ' + m + 'm ' + s + 's';
                }.bind(this), Math.floor(Math.random() * 5) * 1000); // Huehuehuehuehue
                this.setState({interval: interval});
            },

            componentWillUnmount: function() {
                clearInterval(this.state.interval);
            },

            render: function() {
                return (
                    <tr key={ this.props.timer.id }>
                        <td className="type">{ this.props.timer.type }</td>
                        <td className="system"><a href={ "http://evemaps.dotlan.net/search?q=" + this.props.timer.system }>{ this.props.timer.system }</a></td>
                        <td className="region">{ this.props.timer.region }</td>
                        <td className="owner"><a href={ "http://evemaps.dotlan.net/search?q=" + this.props.timer.owner }>{ this.props.timer.owner }</a></td>
                        <td className="time" ref="fuzzytime">{ this.props.timer.time }</td>
                        <td className="remaining" style={{width: '150px'}}><span ref="remaining" style={{fontFamily: "monospace"}}></span></td>
                    </tr>
                );
            }
        });

        var TimerList = React.createClass({
            getInitialState: function() {
                return {
                    sort: {
                        key: 'time',
                        direction: 'asc'
                    },
                };
            },

            handleSortChange: function(event) {
                event.preventDefault();
                var sort = this.state.sort;
                if (sort.key === $(event).data('sort')) {
                    sort.direction = sort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sort.direction = 'asc';
                    sort.key = $(event.currentTarget).data('sort');
                }
                this.setState({sort: sort});
            },

            render: function() {
                if (this.props.timers) {
                    console.log(this.state);
                    var timers = this.props.timers.sort(function(a, b) {
                        var ord;
                        if (a[this.state.sort.key] < b[this.state.sort.key]) { ord = -1; }
                        else if (a[this.state.sort.key] > b[this.state.sort.key]) { ord = 1; }
                        else { ord = 0; }
                        if (this.state.sort.direction === 'desc') { ord = ord * -1; }
                        return ord;
                    }.bind(this)).map(function(timer) {
                        return (<Timer timer={timer} />);
                    });

                    return (
                        <table className="table table-hover" id="timers">
                            <thead>
                                <tr>
                                    <th><a href="#" data-sort="type" onClick={ this.handleSortChange }>Type<span style={{float: 'right'}} id="type" /></a></th>
                                    <th><a href="#" data-sort="system" onClick={ this.handleSortChange }>System<span style={{float: 'right'}} id="system" /></a></th>
                                    <th><a href="#" data-sort="region" onClick={ this.handleSortChange }>Region<span style={{float: 'right'}} id="region" /></a></th>
                                    <th><a href="#" data-sort="owner" onClick={ this.handleSortChange }>Owner<span style={{float: 'right'}} id="owner" /></a></th>
                                    <th><a href="#" data-sort="time" onClick={ this.handleSortChange }>Time<span style={{float: 'right'}} id="time" /></a></th>
                                    <th><a href="#" data-sort="time" onClick={ this.handleSortChange }>Remaining<span style={{float: 'right'}} id="remaining" /></a></th>
                                </tr>
                            </thead>
                            <tbody>
                                { timers }
                            </tbody>
                        </table>
                    );
                } else {
                    return null;
                }
            }
        });

        var typeLookup = {
            1: "TCU",
            2: "IHub",
            3: "Station",
            4: "Freeport"
        };

        websocket = new WebSocket("wss://api.pizza.moe/stream/sovereignty/campaigns/");
        websocket.onopen = function(evt) {
            console.log('Socket opened', evt);
        };
        websocket.onclose = function(evt) {
            console.log('Socket closed ;-)', evt);
        };
        websocket.onmessage = function(evt) {
            var event = JSON.parse(evt["data"]);
            if (event.items) {
                var timers = event.items.map(function(timer) {
                    return {
                        type: typeLookup[timer.eventType],
                        system: timer.sourceSolarsystem.name,
                        region: system2region[timer.sourceSolarsystem.name],
                        time: timer.startTime,
                        realtime: moment(timer.startTime),
                        owner: timer.defender && timer.defender.defender && timer.defender.defender.name ? timer.defender.defender.name : "None",
                        id: typeLookup[timer.eventType] + timer.sourceSolarsystem.name + timer.startTime
                    }
                });
                React.render(
                    <TimerList timers={ timers } />,
                    document.getElementById('timers')
                );
            } else {
                console.log(event);
            }
        };
        websocket.onerror = function(evt) {
            console.error(evt);
        };
    </script>
</body>
</html>
